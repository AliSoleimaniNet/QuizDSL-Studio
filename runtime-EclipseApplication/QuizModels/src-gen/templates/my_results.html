{% extends 'base.html' %}
{% block content %}
<div class='max-w-5xl mx-auto animate-fade-in'>
    <div class='flex justify-between items-center mb-12'>
        <a href='/' class='text-sm opacity-60 hover:opacity-100 transition-all text-[var(--text)] hover:text-[var(--primary)]'><i class='fa-solid fa-arrow-right ml-2'></i> بازگشت به خانه</a>
        <div class='text-right'>
            <h1 class='text-4xl font-black mb-2 text-[var(--text)]'>کارنامه‌های من</h1>
            <p class='text-[var(--text-muted)] text-sm'>تاریخچه و جزئیات عملکرد شما</p>
        </div>
    </div>
    <div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
        {% for res in results %}
        <div class='glass p-8 rounded-[2.5rem] border border-[var(--card-border)] bg-[var(--card-bg)] backdrop-blur-md transition-all duration-300 {% if res.show_result %} cursor-pointer hover:border-[var(--primary)] hover:translate-y-[-5px] group {% endif %}'              {% if res.show_result %} onclick='openResultModal({{ res.id }})' {% endif %}>
            <div class='flex justify-between items-start mb-6'>
                <div class='w-12 h-12 rounded-2xl bg-[var(--primary)]/10 flex items-center justify-center text-[var(--primary)] group-hover:scale-110 transition-transform'>
                    <i class='fa-solid fa-award text-2xl'></i>
                </div>
                <div class='text-left'>
                    <span class='text-[10px] text-[var(--text-muted)] block uppercase tracking-tighter'>Ref ID</span>
                    <span class='font-mono text-xs text-[var(--text)] opacity-60'>{{ res.quiz_id }}</span>
                </div>
            </div>
            <h3 class='font-bold text-xl mb-6 text-[var(--text)] group-hover:text-[var(--primary)] transition-colors'>{{ res.quiz_name }}</h3>
            <div class='flex items-center justify-between p-5 bg-[var(--bg)]/50 rounded-3xl border border-[var(--card-border)]'>
                <span class='text-sm text-[var(--text-muted)]'>امتیاز کسب شده</span>
                <div class='text-2xl font-black text-[var(--primary)]'>
                    {{ res.finalScore }} <span class='text-xs text-[var(--text-muted)] mx-1 font-normal'>از</span> {{ res.maxScore }}
                </div>
            </div>
            {% if res.show_result %}
                <div class='mt-6 text-center text-[10px] uppercase tracking-widest text-[var(--primary)] opacity-60 group-hover:opacity-100 transition-all'>
                    مشاهده جزئیات <i class='fa-solid fa-chevron-left mr-1'></i>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
<div id='resultModal' class='fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-[var(--bg)]/95 backdrop-blur-md transition-opacity duration-300'>
    <div class='bg-[var(--nav-bg)] w-full max-w-2xl max-h-[90vh] overflow-hidden rounded-[3rem] border border-[var(--card-border)] flex flex-col shadow-2xl'>
        <div class='p-6 border-b border-[var(--card-border)] flex justify-between items-center bg-[var(--text)]/5'>
            <button onclick='closeModal()' class='w-10 h-10 rounded-xl hover:bg-red-500/20 hover:text-red-500 transition-all text-[var(--text-muted)] text-2xl'>&times;</button>
            <h2 class='text-lg font-bold text-[var(--text)] tracking-tight'>جزئیات پاسخنامه</h2>
        </div>
        <div id='modalContent' class='p-8 overflow-y-auto flex-1 text-right scrollbar-hide text-[var(--text)]'>
            
        </div>
        <div class='p-6 border-t border-[var(--card-border)] flex justify-between items-center bg-[var(--text)]/5'>
            <button id='nextRes' class='px-8 py-3 rounded-2xl btn-primary text-sm font-bold active:scale-95 transition-transform'>سوال بعدی</button>
            <div id='modalStepInfo' class='text-xs font-mono text-[var(--text-muted)] bg-[var(--bg)] px-4 py-2 rounded-full border border-[var(--card-border)]'></div>
            <button id='prevRes' class='px-8 py-3 rounded-2xl bg-[var(--card-bg)] border border-[var(--card-border)] text-[var(--text)] hover:bg-[var(--primary)]/10 text-sm font-bold transition-all'>قبلی</button>
        </div>
    </div>
</div>
<script>
let currentResponses = []; let currentIndex = 0;
const container = document.getElementById('modalContent');
function openResultModal(resultId) {
    fetch(`/api/result/${resultId}`).then(r => r.json()).then(data => {
        currentResponses = data.responses;
        currentIndex = 0;
        document.getElementById('resultModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        renderResponse();
    });
}
function renderResponse() {
    const resp = currentResponses[currentIndex];
    let scoreStatus = '';
    let indicatorClass = 'border-[var(--card-border)] bg-[var(--bg)]/50';
    let icon = '<i class="fa-solid fa-circle-info opacity-50"></i>';
    if (resp.max_q_score > 0) {
        if (resp.correct === true) {
            scoreStatus = `پاسخ صحیح | نمره: ${resp.earned_q_score} از ${resp.max_q_score}`;
            indicatorClass = 'border-green-500/40 bg-green-500/10 text-green-500';
            icon = '<i class="fa-solid fa-circle-check"></i>';
        } else if (resp.correct === false) {
            scoreStatus = `پاسخ غلط | نمره: 0 از ${resp.max_q_score}`;
            indicatorClass = 'border-red-500/40 bg-red-500/10 text-red-500';
            icon = '<i class="fa-solid fa-circle-xmark"></i>';
        } else {
            scoreStatus = `در انتظار تصحیح | نمره: ؟ از ${resp.max_q_score}`;
            indicatorClass = 'border-yellow-500/40 bg-yellow-500/10 text-yellow-500';
            icon = '<i class="fa-solid fa-circle-question"></i>';
        }
    } else {
        scoreStatus = resp.correct === true ? 'تایید شده' : (resp.correct === false ? 'رد شده' : 'ثبت شده');
    }
    container.innerHTML = `
        <div class='animate-fade-in'>
            <div class='mb-8'>
                <span class='text-[var(--primary)] text-[10px] font-black uppercase tracking-[0.2em] block mb-3 opacity-80'>Question ${currentIndex + 1}</span>
                <h3 class='text-xl font-bold leading-relaxed text-[var(--text)]'>${resp.question_text}</h3>
            </div>
            <div class='p-6 rounded-[2rem] bg-[var(--bg)] border border-[var(--card-border)] mb-6'>
                <div class='text-[10px] text-[var(--text-muted)] mb-3 uppercase tracking-widest'>Your Answer</div>
                <div class='text-lg font-medium text-[var(--text)] opacity-90'>${resp.answer || '<span class="opacity-30 italic font-light">پاسخی ثبت نشده است</span>'}</div>
            </div>
            <div class='flex items-center gap-4 p-5 rounded-2xl border ${indicatorClass} font-bold text-sm transition-all'>
                <span class='text-xl'>${icon}</span>
                <span>${scoreStatus}</span>
            </div>
        </div>
    `;
    document.getElementById('modalStepInfo').innerText = `${currentIndex + 1} / ${currentResponses.length}`;
    document.getElementById('prevRes').classList.toggle('opacity-30', currentIndex === 0);
    document.getElementById('prevRes').disabled = currentIndex === 0;
    document.getElementById('nextRes').innerText = currentIndex === currentResponses.length - 1 ? 'بستن مرور' : 'سوال بعدی';
    document.getElementById('prevRes').onclick = () => { if(currentIndex > 0) { currentIndex--; renderResponse(); } };
    document.getElementById('nextRes').onclick = () => {
        if(currentIndex < currentResponses.length - 1) { currentIndex++; renderResponse(); }
        else { closeModal(); }
    };
}
function closeModal() {
    document.getElementById('resultModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}
</script>
{% endblock %}